# 虚拟机环境搭建

## k8scode

操作系统：CentOS-7.8

资源分配：2核、1G内存(不够的话再改也可以)，最大20G硬盘

网络设置：桥接模式，ip:192.168.1.180

安装设置：English、时区等

### 初始设置

+ **将普通用户加入sudoers**（可选）

  ```shell
  sudo -
  visudo			#最后一行插入 lee ALL=(ALL) ALL
  ```

+ **网络设置**

  ```shell
  vi /etc/sysconfig/network-scripts/ifcfg-cnp0s3	
  #修改
  #BOOTPROTO=static
  #ONBOOT=yes
  #新增
  #IPADDR=192.168.1.180 	#自定义虚拟机的ip地址（主机是192.168.0.107），必须与主机在同一网段
  #NETMASK=255.255.255.0 	#设置子网掩码，跟宿主一样
  #GATEWAY=192.168.1.1  	#默认网关，跟宿主一样
  #DNS1=8.8.8.8 			#DNS
  vi /etc/sysconfig/network
  #NETWORKING=yes
  #HOSTNAME=<...>
  service network restart
  ping www.baidu.com			#测试和外网是否连通
  ```

  > 注意网络环境变化后要改静态IP。

+ **相互注册hostname和ip**

  ```shell
  #k8smaster上的配置，k8snode类似
  [root@localhost ~]# cat /etc/hostname
  localhost.localdomain
  k8scode
  [root@localhost ~]# cat /etc/hosts
  127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
  ::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
  192.168.1.180 	k8scode
  ```


+ **ssh-sever**

  主要是为了可以在物理机终端操作。

  安装ssh-server(系统默认只有ssh客户端没有服务端), 配置/etc/ssh/sshd_config允许以Root用户ssh登录, 重启sshd服务。

  CentOS默认已经安装了，不需要再装。

  ```shell
  ps -ef | grep sshd	#可以看到sshd守护进程正在运行
  ```

+ **必要软件**

  ```shell
  yum update
  yum install -y conntrack ipvsadm ipset jq sysstat curl iptables libseccomp
  ```

+ **关闭防火墙、swap、重置iptables**

  ```shell l
  systemctl stop firewalld && systemctl disable firewalld
  swapoff -a
  iptables -F && iptables -X && iptables -F -t nat && iptables -X -t nat && iptables -P FORWARD ACCEPT
  # 使用下面的命令对文件/etc/fstab操作，注释 /dev/mapper/centos_master-swap  swap  swap    defaults        0 0 这行
  sed -i 's/.*swap.*/#&/' /etc/fstab
  # 关闭selinux
  vi /etc/selinux/config 
  # 将SELINUX=enforcing改为SELINUX=disabled
  setenforce 0
  # 查看selinux状态
  sestatus
  # 关闭dnsmasq(否则可能导致docker容器无法解析域名)
  service dnsmasq stop && systemctl disable dnsmasq
  ```


### 安装Docker

+ 安装包安装

  ```shell
  # 手动下载rpm包
  wget https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.13-3.2.el7.x86_64.rpm
  wget https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-19.03.8-3.el7.x86_64.rpm
  wget https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-cli-19.03.8-3.el7.x86_64.rpm
  # 清理原有版本
  yum remove -y docker* container-selinux
  # 安装rpm包
  yum localinstall -y *.rpm
  # 开机启动
  systemctl enable docker && systemctl start docker
  ```

+ 设置/etc/docker/daemon.json

  ```
  # daemon.json 详细配置示例
  {
    "registry-mirrors": [
      "https://<your_id>.mirror.aliyuncs.com"
    ]
  }
  # 启动docker服务
  systemctl restart docker
  ```

### 私有镜像仓库配置

需要搭建自己的私有镜像仓库，用于存储项目构建生成的镜像；

+ **docker-registry**

```shell
#私有镜像仓库可以放到任意服务器上，这里放到了node节点上。
docker pull registry
docker run --name=private-registry --restart=always -p 5000:5000 -v /root/registry_images:/var/lib/registry -d registry
#将私有镜像仓库添加到docker daemon.json 镜像仓库列表中。insecure-registries是不安全的镜像源列表，registry-mirrors是安全的（有证书等验证）镜像源列表；私有镜像仓库使用insecure-registries即可。
"insecure-registries":["k8snode:5000"]
systemctl daemon-reload
systemctl restart docker
#后续可以将项目打包成docker镜像上传到私有镜像仓库
docker tag <imagename> k8snode:5000/<imagename>:0.0.1
docker push k8snode:5000/<imagename>:0.0.1
```

+ **Harbor**

### Jenkins(Blue Ocean)安装

```shell
docker run \
  -u root \
  -d \
  --name cicd-jenkins \
  --restart=always \
  -p 8080:8080 \
  -p 50000:50000 \
  -v jenkins-data:/var/jenkins_home \
  -v /var/run/docker.sock:/var/run/docker.sock \	# 这一步很重要，可以在容器内部操作外部docker服务
  jenkinsci/blueocean
  #-v参数不指明路径会默认使用在/var/lib/docker/volumes/下的目录（没有则创建）
  
#或者使用swarm的方式
docker service create --name jenkins \
  -u root \
  -p 8080:8080 -p 50000:50000 \
  --mount type=volume,source=jenkins-data,destination=/var/jenkins_home \
  --mount type=bind,source=/var/run/docker.sock,destination=/var/run/docker.sock \
  --constraint node.role==manager \
  jenkinsci/blueocean
  #把Jenkins调度manager。jenkins帮我们部署服务，docker service，docker stack
  
#查看镜像启动日志
docker logs -f cicd-jenkins
```





